name: 'Deploy Preview'
description: |
  Deploy a preview environment to Kubernetes using FluxCD OCIRepository and Kustomization resources.
  This action creates uniquely-named preview deployments that can coexist for multiple concurrent branches/PRs.
  
  Given an existing tenant definition, this action will roll out an isolated preview deployment of that tenant and its accompanying application(s).

  A kubernetes context must already be configured prior to using this action.
  Checkout the [Create Kubernetes context](../create-context) action to create and configure a kubernetes context.
  
  This action is intended to be used in pull request workflows to provide preview environments for testing changes before merging.
  After the pull request is closed/merged, the preview deployment can be cleaned up using the [Teardown Preview](../teardown-preview) action.
  
  The following triggers are recommended for pull request workflows:

  ```yaml
  on:
    pull_request:
      types: [opened, synchronize, reopened]
  ```  

  To show the preview deployment URL in the pull request, use the `preview-url` output of this action and add it to the `environment` key of the workflow job.

  ```yaml
  environment:
    name: pr-\$\{\{ github.event.number \}\}
    url: \$\{\{ steps.deploy-preview.outputs.preview-url \}\}
  ```
  
  To prevent multiple preview deployments for the same PR, it is recommended to add a workflow-level or job-level concurrency group:

  ```yaml
    concurrency:
      group: pr-\$\{\{ github.event.number \}\}
      cancel-in-progress: false
  ```

author: EIDP
branding:
  color: 'blue'
  icon: 'cloud-upload'

inputs:
  environment:
    description: 'The github environment used to deploy to (e.g. `pr-\$\{\{ github.event.pr \}\}`).'
    required: true
    default: ''
  kubernetes-context:
    description: 'The name of the Kubernetes context to use for deployment.'
    required: true
    default: ''
  tenant-name:
    description: 'The tenant name used to identify the tenant definition in the OCI repository.'
    required: true
    default: ''
  reference:
    description: 'A reference used to uniquely identify this preview environment. Among other things, it is used to generate a resource name prefix. Typically this would be the Pull Request number (`github.pr.number`) or branch reference (`github.branch_ref`).'
    required: true
  ci-prefix-length:
    description: 'The number of characters from the reference to include in the CI prefix.'
    required: false
    default: '16'
  chart-version:
    description: 'Optional chart version override.'
    required: false
    default: ''
  timeout:
    description: 'The time to wait for the deployment to be completed successfully.'
    required: false
    default: '5m'

outputs:
  oci-repository-name:
    description: 'The name of the created OCIRepository resource.'
    value: ${{ steps.create-resources.outputs.oci-repository-name }}
  kustomization-name:
    description: 'The name of the created Kustomization resource.'
    value: ${{ steps.create-resources.outputs.kustomization-name }}
  namespace:
    description: 'The target namespace for the deployment.'
    value: ${{ steps.create-resources.outputs.namespace }}
  ci-prefix:
    description: 'The generated CI prefix used for resource naming.'
    value: ${{ steps.generate-names.outputs.ci-prefix }}
  preview-url:
    description: 'The discovered preview deployment URL (empty if not found).'
    value: ${{ steps.discover-url.outputs.preview-url }}

runs:
  using: 'composite'
  steps:
  - name: Verify connectivity
    shell: bash
    run: |
      echo ::group::Verifying Kubernetes connectivity

      kubectl config use-context "${{ inputs.kubernetes-context }}"
      echo "Using context: $(kubectl config current-context)"

      kubectl auth whoami &>/dev/null
      if [ $? -ne 0 ]; then
        echo "âŒ Cannot connect to the cluster using context '${{ inputs.kubernetes-context }}'"
        echo ::group::Kubectl Config
        kubectl config view
        echo ::endgroup::
        exit 1
      fi

      echo "âœ… Successfully connected to cluster"
      echo ::endgroup::

  - name: Generate names
    id: generate-names
    shell: bash
    run: |
      echo ::group::Generating resource names

      # Get the reference for this preview environment
      REFERENCE="${{ inputs.reference }}"
      echo "Using reference: $REFERENCE"

      # Generate CI prefix
      CI_PREFIX_LENGTH=${{ inputs.ci-prefix-length }}
      CI_PREFIX="ci-${REFERENCE:0:$CI_PREFIX_LENGTH}-"
      # Sanitize: lowercase and replace invalid characters
      CI_PREFIX=$(echo "$CI_PREFIX" | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]-')
      echo "Generated CI prefix: $CI_PREFIX"

      # Generate resource names
      TENANT_NAME="${{ inputs.tenant-name }}"
      OCI_REPO_NAME="${CI_PREFIX}${TENANT_NAME}-oci"
      KUSTOMIZATION_NAME="${CI_PREFIX}${TENANT_NAME}-tenant"
      NAMESPACE="${CI_PREFIX}${TENANT_NAME}"

      # Truncate if necessary (Kubernetes limit is 63 chars)
      MAX_LENGTH=63
      if [ ${#OCI_REPO_NAME} -gt $MAX_LENGTH ]; then
        OCI_REPO_NAME="${OCI_REPO_NAME:0:$MAX_LENGTH}"
        echo "âš ï¸ OCIRepository name truncated to $MAX_LENGTH characters: $OCI_REPO_NAME"
      fi
      if [ ${#KUSTOMIZATION_NAME} -gt $MAX_LENGTH ]; then
        KUSTOMIZATION_NAME="${KUSTOMIZATION_NAME:0:$MAX_LENGTH}"
        echo "âš ï¸ Kustomization name truncated to $MAX_LENGTH characters: $KUSTOMIZATION_NAME"
      fi
      if [ ${#NAMESPACE} -gt $MAX_LENGTH ]; then
        NAMESPACE="${NAMESPACE:0:$MAX_LENGTH}"
        echo "âš ï¸ Namespace truncated to $MAX_LENGTH characters: $NAMESPACE"
      fi

      echo "OCIRepository name: $OCI_REPO_NAME"
      echo "Kustomization name: $KUSTOMIZATION_NAME"
      echo "Namespace: $NAMESPACE"

      # Export to outputs
      echo "ci-prefix=$CI_PREFIX" >> $GITHUB_OUTPUT
      echo "oci-repository-name=$OCI_REPO_NAME" >> $GITHUB_OUTPUT
      echo "kustomization-name=$KUSTOMIZATION_NAME" >> $GITHUB_OUTPUT
      echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT

      echo ::endgroup::

  - name: Create resources
    id: create-resources
    shell: bash
    run: |
      echo ::group::Creating FluxCD resources

      OCI_REPO_NAME="${{ steps.generate-names.outputs.oci-repository-name }}"
      KUSTOMIZATION_NAME="${{ steps.generate-names.outputs.kustomization-name }}"
      NAMESPACE="${{ steps.generate-names.outputs.namespace }}"
      CI_PREFIX="${{ steps.generate-names.outputs.ci-prefix }}"
      TENANT_NAME="${{ inputs.tenant-name }}"
      ENVIRONMENT="${{ inputs.environment }}"

      # Determine git branch
      GIT_BRANCH="${{ github.head_ref || github.ref_name }}"

      # Generate names for postBuild substitutes
      HELM_RELEASE_NAME="${CI_PREFIX}${TENANT_NAME}"
      RELEASE_NAME="${CI_PREFIX}${TENANT_NAME}-tenant"

      # Create OCIRepository manifest
      echo "Creating OCIRepository: $OCI_REPO_NAME"

      # Strip trailing hyphen from CI_PREFIX for label (labels can't end with hyphen)
      CI_PREFIX_LABEL="${CI_PREFIX%-}"

      # TODO: give the "eidp-harbor-pull-credential" a more generic name, and always provision the same secret in all instances.
      # This way we don't have to expose this implementation detail to our customers. They have no way of knowing what the secret name is.
      cat <<EOF | kubectl apply -f -
      ---
      apiVersion: source.toolkit.fluxcd.io/v1
      kind: OCIRepository
      metadata:
        name: $OCI_REPO_NAME
        namespace: infra-fluxcd
        labels:
          app.kubernetes.io/managed-by: github-actions
          app.kubernetes.io/created-by: deploy-preview
          preview-deployment: "true"
          ci-prefix: "$CI_PREFIX_LABEL"
      spec:
        interval: 5m
        url: oci://cr.eidp.io/tenant-definitions/$TENANT_NAME
        ref:
          tag: latest
        secretRef:
          name: eidp-harbor-pull-credential
      EOF

      if [ $? -ne 0 ]; then
        echo "âŒ Failed to create OCIRepository"
        exit 1
      fi

      echo "âœ… OCIRepository created successfully"

      # Create Kustomization manifest
      echo "Deploying preview tenant: $KUSTOMIZATION_NAME"

      # Build postBuild substitute section
      CHART_VERSION_YAML=""
      if [ -n "${{ inputs.chart-version }}" ]; then
        CHART_VERSION_YAML="      chartVersion: \"${{ inputs.chart-version }}\""
      fi

      cat <<EOF | kubectl apply -f -
      ---
      apiVersion: kustomize.toolkit.fluxcd.io/v1
      kind: Kustomization
      metadata:
        name: $KUSTOMIZATION_NAME
        namespace: infra-fluxcd
        labels:
          app.kubernetes.io/managed-by: github-actions
          app.kubernetes.io/created-by: deploy-preview
          preview-deployment: "true"
          ci-prefix: "$CI_PREFIX_LABEL"
      spec:
        serviceAccountName: flux-deployment-controller
        interval: 10m
        sourceRef:
          kind: OCIRepository
          name: $OCI_REPO_NAME
        path: ./
        prune: true
        wait: true
        timeout: ${{ inputs.timeout }}
        postBuild:
          substitute:
            instanceName: "eidp"
            clusterName: "development"
            environmentName: "$ENVIRONMENT"
            helmReleaseName: "$HELM_RELEASE_NAME"
            releaseName: "$RELEASE_NAME"
            gitBranch: "$GIT_BRANCH"
            namespace: "$NAMESPACE"
            namePrefix: "$CI_PREFIX"
            objectStoreEndpoint: "https://core.fuga.cloud:8080"
      $CHART_VERSION_YAML
      EOF

      if [ $? -ne 0 ]; then
        echo "âŒ Failed to create Kustomization"
        exit 1
      fi

      echo "âœ… Kustomization created successfully"

      # Export outputs
      echo "oci-repository-name=$OCI_REPO_NAME" >> $GITHUB_OUTPUT
      echo "kustomization-name=$KUSTOMIZATION_NAME" >> $GITHUB_OUTPUT
      echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT

      echo ::endgroup::

  - name: wait
    shell: bash
    run: |
      echo "Waiting 10 seconds for initial resources to be reconciled..."
      sleep 10

  - name: Verify deployment
    id: verify-deployment
    uses: ./verify-up
    with:
      kubernetes-context: ${{ inputs.kubernetes-context }}
      namespace: ${{ steps.generate-names.outputs.namespace }}
      timeout: ${{ inputs.timeout }}
      chart-version: ${{ inputs.chart-version }}

  - name: Discover preview URL
    id: discover-url
    shell: bash
    run: |
      echo ::group::Discovering preview URL

      TARGET_NAMESPACE="${{ steps.generate-names.outputs.namespace }}"
      PREVIEW_URL=""

      # Wait a moment for ingress to be created
      sleep 5

      # Get ingresses in target namespace
      INGRESSES=$(kubectl get ingress -n "$TARGET_NAMESPACE" -o json 2>/dev/null || echo '{"items":[]}')
      INGRESS_COUNT=$(echo "$INGRESSES" | jq '.items | length')

      if [ "$INGRESS_COUNT" -gt 0 ]; then
        echo "Found $INGRESS_COUNT ingress(es) in namespace $TARGET_NAMESPACE"

        # Extract first ingress host
        HOST=$(echo "$INGRESSES" | jq -r '.items[0].spec.rules[0].host // empty' 2>/dev/null)

        if [ -n "$HOST" ]; then
          # Check if TLS is configured
          TLS=$(echo "$INGRESSES" | jq -r '.items[0].spec.tls // empty' 2>/dev/null)

          if [ -n "$TLS" ] && [ "$TLS" != "null" ]; then
            PREVIEW_URL="https://${HOST}"
          else
            PREVIEW_URL="http://${HOST}"
          fi

          echo "âœ… Preview URL discovered: $PREVIEW_URL"
        else
          echo "âš ï¸ Ingress found but no host configured"
        fi
      else
        echo "âš ï¸ No ingress resources found in namespace $TARGET_NAMESPACE"
        echo "Preview deployment is ready but no URL is available"
      fi

      echo "preview-url=$PREVIEW_URL" >> $GITHUB_OUTPUT
      echo ::endgroup::

  - name: Generate GitHub summary
    shell: bash
    if: always()
    run: |
      {
        # Show status header with icon
        if [ "${{ steps.verify-deployment.outcome }}" == "success" ]; then
          echo "## âœ… Preview deployment successful"
        else
          echo "## âŒ Preview deployment failed"
        fi
        echo ""

        echo "### Deployment details"
        echo ""
        echo "| Field | Value |"
        echo "|-------|-------|"
        echo "| **Tenant Name** | \`${{ inputs.tenant-name }}\` |"
        echo "| **CI Prefix** | \`${{ steps.generate-names.outputs.ci-prefix }}\` |"
        echo "| **Namespace** | \`${{ steps.generate-names.outputs.namespace }}\` |"
        echo "| **OCIRepository** | \`${{ steps.generate-names.outputs.oci-repository-name }}\` |"
        echo "| **Kustomization** | \`${{ steps.generate-names.outputs.kustomization-name }}\` |"
        echo "| **Git Branch** | \`${{ github.ref_name }}\` |"

        # Show preview URL if available
        if [ -n "${{ steps.discover-url.outputs.preview-url }}" ]; then
          echo ""
          echo "### ðŸŒ Preview URL"
          echo ""
          echo "**[${{ steps.discover-url.outputs.preview-url }}](${{ steps.discover-url.outputs.preview-url }})**"
        fi

        echo ""
        echo "---"
        echo "*Deployment timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*"
      } >> $GITHUB_STEP_SUMMARY
