name: build

on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main

jobs:
  test-create-context:
    runs-on: kubernetes-runner
    permissions:
      contents: read
      id-token: write
    environment: development
    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Create Kubernetes context
      id: create-context
      uses: ./create-context
      with:
        environment: development
        api-server: ${{ vars.K8S_API_SERVER_DEVELOPMENT }}
        certificate-authority-data: ${{ secrets.K8S_CERTIFICATE_AUTHORITY_DATA_DEVELOPMENT }}
        print-jwt-claims: 'true'

    - name: Verify context created
      id: verify-context
      run: |
        # Verify the context exists
        if ! kubectl config get-contexts ${{ steps.create-context.outputs.context-name }} &>/dev/null; then
          echo "❌ Context '${{ steps.create-context.outputs.context-name }}' does not exist"
          kubectl config get-contexts
          exit 1
        fi
        echo "✅ Context '${{ steps.create-context.outputs.context-name }}' exists"

        # Verify it's the current context
        CURRENT_CONTEXT=$(kubectl config current-context)
        if [ "$CURRENT_CONTEXT" != "${{ steps.create-context.outputs.context-name }}" ]; then
          echo "❌ Current context is '$CURRENT_CONTEXT', expected '${{ steps.create-context.outputs.context-name }}'"
          exit 1
        fi
        echo "✅ Context '${{ steps.create-context.outputs.context-name }}' is current"

        # Verify basic connectivity
        if ! kubectl auth whoami &>/dev/null; then
          echo "❌ Cannot connect to cluster"
          exit 1
        fi
        echo "✅ Successfully connected to cluster"
        echo "Authenticated as:"
        kubectl auth whoami

        echo "username=$(kubectl auth whoami -o json | jq -r '.status.userInfo.username')" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Assert Kubernetes username
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: github:repo:${{ github.repository}}:environment:development
        actual: ${{ steps.verify-context.outputs.username }}

    - name: Assert Action Status
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: success
        actual: ${{ steps.create-context.outcome }}

  test-verify-up:
    runs-on: kubernetes-runner
    permissions:
      contents: read
      id-token: write
    environment: development
    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Create Kubernetes context
      id: create-context
      uses: ./create-context
      with:
        environment: development
        api-server: ${{ vars.K8S_API_SERVER_DEVELOPMENT }}
        certificate-authority-data: ${{ secrets.K8S_CERTIFICATE_AUTHORITY_DATA_DEVELOPMENT }}
        print-jwt-claims: 'true'

    - name: "verify-up: invalid namespace"
      id: verify-up-invalid-namespace
      uses: ./verify-up
      continue-on-error: true
      with:
        kubernetes-context: ${{ steps.create-context.outputs.context-name }}
        namespace: non-existing-namespace
        timeout: 30s

    - name: Assert verify-up invalid namespace status
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: failure
        actual: ${{ steps.verify-up-invalid-namespace.outcome }}

    - name: "verify-up: missing resource"
      id: verify-up-missing-resource
      uses: ./verify-up
      continue-on-error: true
      with:
        kubernetes-context: ${{ steps.create-context.outputs.context-name }}
        namespace: apps-actions-kubernetes
        flux-resource: helmrelease/non-existing-release
        timeout: 30s

    - name: Assert verify-up missing resource status
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: failure
        actual: ${{ steps.verify-up-missing-resource.outcome }}

    - name: "verify-up: with flux resource (happy-flow)"
      id: verify-up-with-resource
      uses: ./verify-up
      with:
        kubernetes-context: ${{ steps.create-context.outputs.context-name }}
        namespace: apps-actions-kubernetes
        flux-resource: helmrelease/echo-server-release

    - name: Assert verify-up happy flow status
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: success
        actual: ${{ steps.verify-up-with-resource.outcome }}

    - name: "verify-up: no flux resource (happy-flow)"
      id: verify-up-no-flux-resource
      uses: ./verify-up
      with:
        kubernetes-context: ${{ steps.create-context.outputs.context-name }}
        namespace: apps-actions-kubernetes

    - name: Assert verify-up happy flow status
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: success
        actual: ${{ steps.verify-up-no-flux-resource.outcome }}

  test-deploy-preview:
    runs-on: kubernetes-runner
    permissions:
      contents: read
      id-token: write
    environment:
      name: pr-${{ github.event.number || github.ref_name }}
      url: ${{ steps.deploy-preview-happy.outputs.preview-url }}
    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Create Kubernetes context
      id: create-context
      uses: ./create-context
      with:
        environment: development
        api-server: ${{ vars.K8S_API_SERVER_DEVELOPMENT }}
        certificate-authority-data: ${{ secrets.K8S_CERTIFICATE_AUTHORITY_DATA_DEVELOPMENT }}
        print-jwt-claims: 'true'

    - name: "deploy-preview: happy flow"
      id: deploy-preview-happy
      uses: ./deploy-preview
      with:
        kubernetes-context: ${{ steps.create-context.outputs.context-name }}
        tenant-name: actions-kubernetes
        reference: ${{ github.event.number || github.ref_name }}
        timeout: 10m

    - name: Assert deploy-preview happy flow status
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: success
        actual: ${{ steps.deploy-preview-happy.outcome }}

    - name: Assert deploy-preview outputs exist
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: true
        actual: ${{ steps.deploy-preview-happy.outputs.oci-repository-name != '' && steps.deploy-preview-happy.outputs.kustomization-name != '' && steps.deploy-preview-happy.outputs.ci-prefix != '' }}

    - name: Verify preview resources exist
      run: |
        echo "Verifying OCIRepository exists..."
        kubectl get ocirepository ${{ steps.deploy-preview-happy.outputs.oci-repository-name }} -n infra-fluxcd

        echo "Verifying Kustomization exists..."
        kubectl get kustomization ${{ steps.deploy-preview-happy.outputs.kustomization-name }} -n infra-fluxcd

        echo "✅ All preview resources verified"

    - name: Cleanup preview deployment
      if: always()
      continue-on-error: true
      run: |
        echo "Cleaning up preview deployment resources..."
        kubectl delete kustomization ${{ steps.deploy-preview-happy.outputs.kustomization-name }} -n infra-fluxcd --ignore-not-found=true
        kubectl delete ocirepository ${{ steps.deploy-preview-happy.outputs.oci-repository-name }} -n infra-fluxcd --ignore-not-found=true
        echo "✅ Cleanup complete"

  check-workflow-status:
    runs-on: kubernetes-runner
    permissions:
      contents: read
      actions: read
    steps:
    - name: Check Workflow Status
      id: check-workflow-status
      uses: eidp/actions-common/check-workflow-status@82bb2cfb07c831032efe550b99659804b2625fd2 # v1.2.1
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
