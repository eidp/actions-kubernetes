name: build

on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main

jobs:
  test-typescript:
    runs-on: kubernetes-runner
    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Setup Node.js
      uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
      with:
        node-version-file: .node-version
        cache: npm

    - name: Install Dependencies
      run: npm ci

    - name: Check Format
      id: npm-format-check
      run: npm run format:check

    - name: Lint
      id: npm-lint
      run: npm run lint

    - name: Test
      id: npm-ci-test
      run: npm run ci-test

  test-create-context:
    runs-on: kubernetes-runner
    permissions:
      contents: read
      id-token: write
    environment: development
    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Install kubectl
      uses: azure/setup-kubectl@776406bce94f63e41d621b960d78ee25c8b76ede # v4.0.1

    - name: Create Kubernetes context
      id: create-context
      uses: ./create-context
      with:
        environment: development
        api-server: ${{ vars.K8S_API_SERVER_DEVELOPMENT }}
        certificate-authority-data: ${{ secrets.K8S_CERTIFICATE_AUTHORITY_DATA_DEVELOPMENT }}
        print-jwt-claims: 'true'

    - name: Verify context created
      id: verify-context
      run: |
        # Verify the context exists
        if ! kubectl config get-contexts ${{ steps.create-context.outputs.context-name }} &>/dev/null; then
          echo "❌ Context '${{ steps.create-context.outputs.context-name }}' does not exist"
          kubectl config get-contexts
          exit 1
        fi
        echo "✅ Context '${{ steps.create-context.outputs.context-name }}' exists"

        # Verify it's the current context
        CURRENT_CONTEXT=$(kubectl config current-context)
        if [ "$CURRENT_CONTEXT" != "${{ steps.create-context.outputs.context-name }}" ]; then
          echo "❌ Current context is '$CURRENT_CONTEXT', expected '${{ steps.create-context.outputs.context-name }}'"
          exit 1
        fi
        echo "✅ Context '${{ steps.create-context.outputs.context-name }}' is current"

        # Verify basic connectivity
        if ! kubectl auth whoami &>/dev/null; then
          echo "❌ Cannot connect to cluster"
          exit 1
        fi
        echo "✅ Successfully connected to cluster"
        echo "Authenticated as:"
        kubectl auth whoami

        echo "username=$(kubectl auth whoami -o json | jq -r '.status.userInfo.username')" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Assert Kubernetes username
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: github:repo:${{ github.repository}}:environment:development
        actual: ${{ steps.verify-context.outputs.username }}

    - name: Assert Action Status
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: success
        actual: ${{ steps.create-context.outcome }}

  test-verify-up:
    runs-on: kubernetes-runner
    permissions:
      contents: read
      id-token: write
    environment: development
    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Create Kubernetes context
      id: create-context
      uses: ./create-context
      with:
        environment: development
        api-server: ${{ vars.K8S_API_SERVER_DEVELOPMENT }}
        certificate-authority-data: ${{ secrets.K8S_CERTIFICATE_AUTHORITY_DATA_DEVELOPMENT }}
        print-jwt-claims: 'true'

    - name: Install kubectl
      uses: azure/setup-kubectl@776406bce94f63e41d621b960d78ee25c8b76ede # v4.0.1

    - name: 'verify-up: invalid namespace'
      id: verify-up-invalid-namespace
      uses: ./verify-up
      continue-on-error: true
      with:
        kubernetes-context: ${{ steps.create-context.outputs.context-name }}
        namespace: non-existing-namespace
        timeout: 30s

    - name: Assert verify-up invalid namespace status
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: failure
        actual: ${{ steps.verify-up-invalid-namespace.outcome }}

    - name: 'verify-up: missing resource'
      id: verify-up-missing-resource
      uses: ./verify-up
      continue-on-error: true
      with:
        kubernetes-context: ${{ steps.create-context.outputs.context-name }}
        namespace: apps-actions-kubernetes
        flux-resource: helmrelease/non-existing-release
        timeout: 30s

    - name: Assert verify-up missing resource status
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: failure
        actual: ${{ steps.verify-up-missing-resource.outcome }}

    - name: 'verify-up: with flux resource (happy-flow)'
      id: verify-up-with-resource
      uses: ./verify-up
      with:
        kubernetes-context: ${{ steps.create-context.outputs.context-name }}
        namespace: apps-actions-kubernetes
        flux-resource: helmrelease/echo-server-release

    - name: Assert verify-up happy flow status
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: success
        actual: ${{ steps.verify-up-with-resource.outcome }}

    - name: 'verify-up: no flux resource (happy-flow)'
      id: verify-up-no-flux-resource
      uses: ./verify-up
      with:
        kubernetes-context: ${{ steps.create-context.outputs.context-name }}
        namespace: apps-actions-kubernetes

    - name: Assert verify-up happy flow status
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: success
        actual: ${{ steps.verify-up-no-flux-resource.outcome }}

  test-deploy-preview:
    runs-on: kubernetes-runner
    permissions:
      contents: read
      id-token: write
    environment:
      name: pr-${{ github.event.number || github.ref_name }}
      url: ${{ steps.deploy-preview.outputs.preview-url }}
    outputs:
      oci-repository-name: ${{ steps.deploy-preview.outputs.oci-repository-name }}
      kustomization-name: ${{ steps.deploy-preview.outputs.kustomization-name }}
    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Create Kubernetes context
      id: create-context
      uses: ./create-context
      with:
        environment: development
        api-server: ${{ vars.K8S_API_SERVER_DEVELOPMENT }}
        certificate-authority-data:
          ${{ secrets.K8S_CERTIFICATE_AUTHORITY_DATA_DEVELOPMENT }}
        print-jwt-claims: 'true'

    - name: Install kubectl
      uses: azure/setup-kubectl@776406bce94f63e41d621b960d78ee25c8b76ede # v4.0.1

    - name: 'deploy-preview: happy flow'
      id: deploy-preview
      uses: ./deploy-preview
      with:
        environment: 'pr-${{ github.event.number || github.ref_name }}'
        kubernetes-context: ${{ steps.create-context.outputs.context-name }}
        # We are deliberately using an older chart version here to test the action's ability to deploy a custom chart version.
        chart-version: '0.4.0'
        tenant-name: actions-kubernetes
        reference: ${{ github.event.number || github.ref_name }}
        timeout: 5m

    - name: Assert deploy-preview happy flow status
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: success
        actual: ${{ steps.deploy-preview.outcome }}

    - name: Assert deploy-preview outputs exist
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: true
        actual:
          ${{ steps.deploy-preview.outputs.oci-repository-name != '' &&
          steps.deploy-preview.outputs.kustomization-name != '' &&
          steps.deploy-preview.outputs.ci-prefix != '' }}

    - name: Verify preview resources exist
      run: |
        echo "Verifying OCIRepository exists..."
        kubectl get ocirepository ${{ steps.deploy-preview.outputs.oci-repository-name }} -n infra-fluxcd

        echo "Verifying Kustomization exists..."
        kubectl get kustomization ${{ steps.deploy-preview.outputs.kustomization-name }} -n infra-fluxcd

        echo "✅ All preview resources verified"

    - name: 'Verify preview deployment successful'
      uses: ./verify-up
      with:
        kubernetes-context: ${{ steps.create-context.outputs.context-name }}
        namespace: ${{ steps.deploy-preview.outputs.namespace }}
        chart-version: '0.4.0'
        initial-wait: '10'

  test-teardown-preview:
    needs: test-deploy-preview
    runs-on: kubernetes-runner
    permissions:
      contents: read
      id-token: write
      pull-requests: read
    environment:
      name: pr-${{ github.event.number || github.ref_name }}
    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Create Kubernetes context
      id: create-context
      uses: ./create-context
      with:
        environment: development
        api-server: ${{ vars.K8S_API_SERVER_DEVELOPMENT }}
        certificate-authority-data:
          ${{ secrets.K8S_CERTIFICATE_AUTHORITY_DATA_DEVELOPMENT }}
        print-jwt-claims: 'true'

    - name: Install kubectl
      uses: azure/setup-kubectl@776406bce94f63e41d621b960d78ee25c8b76ede # v4.0.1

    - name: 'Teardown Preview dry-run'
      id: teardown-preview-dry-run
      uses: ./teardown-preview
      with:
        kubernetes-context: ${{ steps.create-context.outputs.context-name }}
        reference: ${{ github.event.number || github.ref_name }}
        dry-run: 'true'

    - name: Assert teardown preview dry-run outputs
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: 1
        actual: ${{ steps.teardown-preview-dry-run.outputs.deleted-count }}

    - name: 'Teardown Preview bulk dry-run'
      id: teardown-preview-bulk-dry-run
      uses: ./teardown-preview
      with:
        kubernetes-context: ${{ steps.create-context.outputs.context-name }}
        dry-run: 'true'

    - name: Assert teardown preview bulk dry-run outputs
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: true
        # We need to validate if the deleted-count is at least 1, as there might be other previews envs present from other PRs.
        actual: ${{ steps.teardown-preview-bulk-dry-run.outputs.deleted-count >= 1 }}

    - name: 'Teardown Preview'
      id: teardown-preview
      uses: ./teardown-preview
      with:
        kubernetes-context: ${{ steps.create-context.outputs.context-name }}
        reference: ${{ github.event.number || github.ref_name }}
        wait-for-deletion: 'true'

    - name: 'Verify that preview deployment resources do not exist anymore'
      run: |
        set -e

        echo "Verifying OCIRepository is deleted..."
        if kubectl get ocirepository ${{ needs.test-deploy-preview.outputs.oci-repository-name }} -n infra-fluxcd &>/dev/null; then
        echo "❌ OCIRepository '${{ needs.test-deploy-preview.outputs.oci-repository-name }}' still exists"
        exit 1
        fi
        echo "✅ OCIRepository deleted"

        echo "Verifying Kustomization is deleted..."
        if kubectl get kustomization ${{ needs.test-deploy-preview.outputs.kustomization-name }} -n infra-fluxcd &>/dev/null; then
        echo "❌ Kustomization '${{ needs.test-deploy-preview.outputs.kustomization-name }}' still exists"
        exit 1
        fi
        echo "✅ Kustomization deleted"

        echo "✅ All preview resources successfully deleted"

  check-workflow-status:
    runs-on: kubernetes-runner
    permissions:
      contents: read
      actions: read
    steps:
    - name: Check Workflow Status
      id: check-workflow-status
      uses: eidp/actions-common/check-workflow-status@82bb2cfb07c831032efe550b99659804b2625fd2 # v1.2.1
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
