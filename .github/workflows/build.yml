name: build

on:
  push:
    branches:
    - main
  pull_request:

jobs:
  test-typescript:
    runs-on: kubernetes-runner
    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Setup pnpm
      uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

    - name: Setup Node.js
      uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
      with:
        node-version-file: .node-version
        cache: pnpm

    - name: Install Dependencies
      run: pnpm install --frozen-lockfile

    - name: Check Format
      id: format-check
      run: pnpm run format:check

    - name: Lint
      id: lint
      run: pnpm run lint

    - name: Test
      id: test
      run: pnpm run test:ci

    - name: Test Report
      uses: dorny/test-reporter@dc3a92680fcc15842eef52e8c4606ea7ce6bd3f3 # v2.1.1
      if: ${{ !cancelled() }}
      with:
        name: Vitest tests
        path: junit/test-results.xml
        reporter: jest-junit

  test-create-context:
    runs-on: kubernetes-runner
    if: github.event_name != 'issue_comment'
    permissions:
      contents: read
      id-token: write
    environment: development
    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Install kubectl
      uses: azure/setup-kubectl@776406bce94f63e41d621b960d78ee25c8b76ede # v4.0.1

    - name: Create Kubernetes context
      id: create-context
      uses: ./create-context
      with:
        cluster: development
        api-server: ${{ vars.K8S_API_SERVER_DEVELOPMENT }}
        certificate-authority-data: ${{ secrets.K8S_CERTIFICATE_AUTHORITY_DATA_DEVELOPMENT }}
        print-jwt-claims: 'true'

    - name: Verify context created
      id: verify-context
      run: |
        # Verify the context exists
        if ! kubectl config get-contexts ${{ steps.create-context.outputs.context-name }} &>/dev/null; then
          echo "❌ Context '${{ steps.create-context.outputs.context-name }}' does not exist"
          kubectl config get-contexts
          exit 1
        fi
        echo "✅ Context '${{ steps.create-context.outputs.context-name }}' exists"

        # Verify it's the current context
        CURRENT_CONTEXT=$(kubectl config current-context)
        if [ "$CURRENT_CONTEXT" != "${{ steps.create-context.outputs.context-name }}" ]; then
          echo "❌ Current context is '$CURRENT_CONTEXT', expected '${{ steps.create-context.outputs.context-name }}'"
          exit 1
        fi
        echo "✅ Context '${{ steps.create-context.outputs.context-name }}' is current"

        # Verify basic connectivity
        if ! kubectl auth whoami &>/dev/null; then
          echo "❌ Cannot connect to cluster"
          exit 1
        fi
        echo "✅ Successfully connected to cluster"
        echo "Authenticated as:"
        kubectl auth whoami

        echo "username=$(kubectl auth whoami -o json | jq -r '.status.userInfo.username')" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Assert Kubernetes username
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: github:repo:${{ github.repository}}:environment:development
        actual: ${{ steps.verify-context.outputs.username }}

    - name: Assert Action Status
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: success
        actual: ${{ steps.create-context.outcome }}

  test-verify-up:
    runs-on: kubernetes-runner
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    environment: development
    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Create Kubernetes context
      id: create-context
      uses: ./create-context
      with:
        cluster: development
        api-server: ${{ vars.K8S_API_SERVER_DEVELOPMENT }}
        certificate-authority-data: ${{ secrets.K8S_CERTIFICATE_AUTHORITY_DATA_DEVELOPMENT }}
        print-jwt-claims: 'true'

    - name: Install kubectl
      uses: azure/setup-kubectl@776406bce94f63e41d621b960d78ee25c8b76ede # v4.0.1

    - name: 'verify-up: invalid namespace'
      id: verify-up-invalid-namespace
      uses: ./verify-up
      continue-on-error: true
      with:
        environment: development
        kubernetes-context: ${{ steps.create-context.outputs.context-name }}
        namespace: non-existing-namespace
        timeout: 10s
        github-token: ${{ github.token }}

    - name: Assert verify-up invalid namespace status
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: failure
        actual: ${{ steps.verify-up-invalid-namespace.outcome }}

    - name: 'verify-up: missing resource'
      id: verify-up-missing-resource
      uses: ./verify-up
      continue-on-error: true
      with:
        environment: development
        kubernetes-context: ${{ steps.create-context.outputs.context-name }}
        namespace: apps-actions-kubernetes
        flux-resource: helmrelease/non-existing-release
        timeout: 10s
        github-token: ${{ github.token }}

    - name: Assert verify-up missing resource status
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: failure
        actual: ${{ steps.verify-up-missing-resource.outcome }}

    - name: 'verify-up: with flux resource (happy-flow)'
      id: verify-up-with-resource
      uses: ./verify-up
      with:
        environment: development
        kubernetes-context: ${{ steps.create-context.outputs.context-name }}
        namespace: apps-actions-kubernetes
        flux-resource: helmrelease/echo-server-release
        github-token: ${{ github.token }}

    - name: Assert verify-up happy flow status
      uses: nick-fields/assert-action@aa0067e01f0f6545c31755d6ca128c5a3a14f6bf # v2.0.0
      with:
        expected: success
        actual: ${{ steps.verify-up-with-resource.outcome }}

  check-workflow-status:
    runs-on: kubernetes-runner
    permissions:
      contents: read
      actions: read
    steps:
    - name: Check Workflow Status
      id: check-workflow-status
      uses: eidp/actions-common/check-workflow-status@82bb2cfb07c831032efe550b99659804b2625fd2 # v1.2.1
      with:
        github-token: ${{ github.token }}
