name: check-transpiled-javascript

on:
  pull_request:
    branches:
    - main
  push:
    branches:
    - main

permissions:
  contents: read

jobs:
  check-dist:
    name: Check compiled actions dist/ folders
    runs-on: kubernetes-runner

    steps:
    - name: Checkout
      id: checkout
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Setup Node.js
      uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
      with:
        node-version-file: .node-version
        cache: npm

    - name: Install Dependencies
      id: install
      run: npm ci

    - name: Build actions
      id: build
      run: npm run bundle

    # This will fail the workflow if any of the actions `dist/` directories is different than
    # expected.
    - name: Compare Directories
      id: diff
      run: |
        # Find all dist directories in action folders
        DIST_DIRS=$(find . -maxdepth 2 -type d -name dist -not -path "*/node_modules/*")

        if [ -z "$DIST_DIRS" ]; then
          echo "No dist/ directories found. See status below:"
          ls -la ./
          exit 1
        fi

        echo "Checking dist directories:"
        echo "$DIST_DIRS"
        echo ""

        # Check each dist directory for changes
        HAS_CHANGES=0
        for dist in $DIST_DIRS; do
          if [ "$(git diff --ignore-space-at-eol --text "$dist" | wc -l)" -gt "0" ]; then
            echo "Detected uncommitted changes in $dist:"
            git diff --ignore-space-at-eol --text "$dist"
            HAS_CHANGES=1
          fi
        done

        if [ $HAS_CHANGES -eq 1 ]; then
          echo ""
          echo "ERROR: Detected uncommitted changes after build."
          echo "Please run 'npm run bundle' and commit the changes."
          exit 1
        fi

        echo "All dist directories are up to date!"
